
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Blog of oxcarxierra">
    <title>[React Native] Firebase 전화번호 인증 기능 추가하기 (Feat. 안드로이드 자동 인증) - Blog of oxcarxierra</title>
    <meta name="author" content="oxcarxierra | 오승석">
    
        <meta name="keywords" content="오승석,oxcarxierra,Seungseok Oh,서울과학고등학교,서울대학교,">
    
    
        <link rel="icon" href="https://oxcarxierra.github.io/assets/images/airplane.svg">
    
    
        
            <link rel="alternate" type="application/atom+xml" title="RSS" href="/feed.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"oxcarxierra | 오승석","sameAs":["https://github.com/OXcarXierra","https://www.linkedin.com/in/oh-seungseok-370746242/","https://www.instagram.com/_oscarsierra_/"],"image":"profile.jpg"},"articleBody":"\n\n\nHYPE 앱은 전화번호 기반으로 유저 로그인, 회원가입이 이루어지기 때문에 전화번호 인증이 필수적이었다. 그래서 Google Firebase에서 제공하는 문자메세지 인증 서비스를 처음으로 사용해보게 되었다.\nGoogle Firebase 연동하기먼저 개발하려는 앱과 프로젝트를 연동해주어야 한다. React Native 프로젝트에 쉽게 프로젝트를 연동할 수 있는 react-native-firebase 라이브러리를 사용하면 편하다.연동하는 일련의 방법은 공식문서 및 블로그를 참고했다. Firebase 공식문서는 Swift와 Kotlin 기반으로 설명이 되어있어서, 타 블로그가 도움이 많이 되었다.\nFirebase에서는 여러 가지 방법의 Authentication(인증)수단을 제공하는데, 그 중 전화(phone)을 이용하면 유저가 입력한 번호로 인증번호를 전송할 수 있다. 그리고 유저가 입력한 인증번호와 대조하면 핸드폰 번호 인증이 가능해진다.\n인증번호 전송 및 대조 검증 코드대부분의 로직은 React Native Firebase에서 제공하는 Phone Authentication 공식문서를 참고하면 된다.전화번호 인증의 전체적인 로직은 이렇다.\n\n전화번호를 매개변수로 signInWithPhoneNumber()함수를 호출하고, 반환된 값을 state로 저장한다.\n그러면 firebase에서 해당 전화번호로 OTP(One Time Passcode)가 전송된다.\n유저에게서 OTP를 입력받고, 이를 state에 저장된 변수 내 confirm()함수의 매개변수로 넣는다.\n인증번호가 맞다면 문제가 없지만, 인증번호가 틀리거나 만료된다면 Error가 반환한다.\n\n전체 코드는 아래와 같다.\n1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162const SignInComponent = () =&gt; &#123;  const [phone, setPhone] = useState&lt;string&gt;(&quot;&quot;);  const [verificationCode, setVerificationCode] = useState&lt;string&gt;(&quot;&quot;);  const [confirm, setConfirm] =    useState&lt;FirebaseAuthTypes.ConfirmationResult | null&gt;(null);  const [authenticated, setAuthenticated] = useState&lt;boolean&gt;(false);  const requestSignInWithPhoneNumber = async (phone: string) =&gt; &#123;    try &#123;      // 입력받은 전화번호에 국가코드 추가      const confirmation = await auth().signInWithPhoneNumber(`+82 $&#123;phone&#125;`);      setConfirm(confirmation);      return true;    &#125; catch (err) &#123;      Alert.alert(        &quot;인증번호를 정상적으로 전송하지 못했어요. 다시 시도해주세요.&quot;      );      return false;    &#125;  &#125;;  // 인증번호 전송 버튼 클릭시 실행 호출  const onPressSendCode = async (phone: string) =&gt; &#123;    // 번호가 11자리가 아니거나, 이미 존재하는 번호이면 여기서 예외처리    const onSuccessSignInPhoneNumber = await requestSignInWithPhoneNumber(      phone    );    if (onSuccessSignInPhoneNumber) &#123;      // 인증번호가 정상적으로 발송되었을 때 처리    &#125;  &#125;;  const requestConfirmVerificationCode = async (code: string) =&gt; &#123;    try &#123;      await confirm!!.confirm(code);      return true;    &#125; catch (err) &#123;      Alert.alert(&quot;인증번호가 일치하지 않아요. 다시 시도해주세요.&quot;);      return false;    &#125;  &#125;;  const confirmCode = async (code: string) =&gt; &#123;    const res = await requestConfirmVerificationCode(code);    if (res) &#123;      setAuthenticated(true);    &#125;  &#125;;  // 폰인증 백그라운드 자동 인증 리스너 추가 for 안드로이드  useEffect(() =&gt; &#123;    const subscriber = auth().onAuthStateChanged((user) =&gt; &#123;      if (user) &#123;        setAuthenticated(true);      &#125;    &#125;);    return subscriber; // 성공시 listener 제거  &#125;, []);  return (    // 렌더링될 부분  )\n\nTroubleshooting⚠️ Google Playstore 등록 이후 실기기에서 인증번호 발송 실패 이슈안드로이드 시뮬레이터에서는 정상적으로 동작하던 인증이 Playstore을 통해서 배포된 앱에서는 Error: [auth/invalid-app-credential] Invalid token에러가 발생한다면, Playstore 앱 서명 SHA-1과 SHA-256 키를 Firebase에 등록했는지 다시 확인해보는 것이 좋다.\n앱을 Firebase에 처음으로 연동할 때, SHA-1 키를 입력하고 google-service.json을 다운로드하는 과정을 거친다. 이때 들어가는 SHA-1 키는 디버그용 키이기 때문에, 릴리즈용 키와 Playstore 앱 서명 키까지 추가로 다시 등록해주어야 한다.\n릴리즈용 SHA-1, SHA-256 Key는 터미널에서 아래 커맨드를 입력하여 얻을 수 있다.\n1keytool -list -v -keystore &quot;C:\\work\\prj1\\prj1.jks&quot;\n\nPlaystore 앱 서명 키는 Play Console - 설정(좌측 메뉴) - 앱 무결성 - 앱 서명 에서 확인할 수 있다. 업로드 키가 아닌 앱 서명 키를 이용해야 한다!\n이후 Firebase Console - 앱 설정 - Android 앱 - SHA 인증서 지문 에서 디지털 지문 추가를 클릭해 위에서 얻은 키를 입력해주고, 다시 google-service.json을 앱 폴더 내에 위치시키면 끝!\n⚠️ Android 기기에서 인증번호 자동 인증으로 인한 인증번호 만료 이슈모든 설정을 마쳤는데도, Android 실기기에서만 인증번호를 확인하는 confirm함수에서 계속 오류를 반환했다. 오류를 재현하는 것 부터 까다로웠는데,\n\niOS 기기는 전혀 문제가 없음\nAndroid Simulator에서 테스트 전화번호로 하면 문제가 없음.\nAndroid Simulator에서 실기기 전화번호로 인증번호를 받으면 문제가 없음.\nAndroid 실기기에서 테스트 전화번호로 하면 문제가 없음.\nAndroid 실기기에서 실기기 전화번호로 인증번호를 받아 입력하면 오류가 발생\n\n이유는 안드로이드 일부 기기에서 문자로 보내진 인증번호를 이용해 자동으로 인증을 진행하기 때문이었다. 그래서 confirm함수는 이미 실행되고 인증까지 된 상태에서 유저가 똑같은 OTP를 이용해 수동으로 한 번 더 인증을 하니 auth/session-expired 오류가 떴던 것이다.\n공식문서의 설명은 아래와 같다.\n\nSome Android devices can automatically process the verification code (OTP) message, and the user would NOT need to enter the code.Actually, if he&#x2F;she tries to enter it, he&#x2F;she will get an error message because the code was already used in the background.In this function, make sure you hide the component(s) for entering the code and&#x2F;or navigate away from this screen.It is also recommended to display a message to the user informing him&#x2F;her that he&#x2F;she has successfully logged in.\n\n그래서 인증화면에서는 아래처럼 onAuthStateChanged 리스너를 둬서 로그인(또는 회원가입)이 되어 user객체가 생긴 걸 감지하도록 해야한다.\n12345678useEffect(() =&gt; &#123;  const subscriber = auth().onAuthStateChanged((user) =&gt; &#123;    if (user) &#123;      setAuthenticated(true);    &#125;  &#125;);  return subscriber; // 성공시 listener 제거&#125;, []);\n\n이 오류를 발견하고 고치는데에 일주일정도 삽질을 했던 것 같다… 이렇게 오랜 시간이 소요됐던 건 네 가지 병크가 겹쳤기 때문이라고 본다.\n\n일단 공식문서의 초록 주석을 제대로 안읽었음. 몇몇 기기에서는 자동인증이 진행될 수 있다는 내용을 몰랐음.\n실기기에서는 console창에 에러메세지가 뜨지 않아서 OTP expire 오류인지 알아내는데 며칠이 걸렸음.\n안드로이드 실기기가 없어서 애초에 디버깅을 지인 핸드폰으로 했기에 시간제한이 있었음.\n디버깅하려면 수정 -&gt; 새로 빌드(및 버전 업) -&gt; 실기기에서 앱 업데이트 -&gt; 확인의 과정을 매번 거쳐야 해서 속도가 느렸음.\n\n안드로이드 자동인증 만든넘… 밤길 조심하세요 진짜","dateCreated":"2023-04-08T01:57:43+09:00","dateModified":"2023-04-08T01:57:43+09:00","datePublished":"2023-04-08T01:57:43+09:00","description":"Google Firebase를 이용하여 React Native 프로젝트에 전화번호 인증 기능을 추가해보자.","headline":"[React Native] Firebase 전화번호 인증 기능 추가하기 (Feat. 안드로이드 자동 인증)","image":["https://i.imgur.com/8tlrvDv.png"],"mainEntityOfPage":{"@type":"WebPage","@id":"https://oxcarxierra.github.io/Development/rn-firebase-phone-auth/"},"publisher":{"@type":"Organization","name":"oxcarxierra | 오승석","sameAs":["https://github.com/OXcarXierra","https://www.linkedin.com/in/oh-seungseok-370746242/","https://www.instagram.com/_oscarsierra_/"],"image":"profile.jpg","logo":{"@type":"ImageObject","url":"profile.jpg"}},"url":"https://oxcarxierra.github.io/Development/rn-firebase-phone-auth/","thumbnailUrl":"https://i.imgur.com/8tlrvDv.png"}</script>
    <meta name="description" content="Google Firebase를 이용하여 React Native 프로젝트에 전화번호 인증 기능을 추가해보자.">
<meta property="og:type" content="blog">
<meta property="og:title" content="[React Native] Firebase 전화번호 인증 기능 추가하기 (Feat. 안드로이드 자동 인증)">
<meta property="og:url" content="https://oxcarxierra.github.io/Development/rn-firebase-phone-auth/index.html">
<meta property="og:site_name" content="Blog of oxcarxierra">
<meta property="og:description" content="Google Firebase를 이용하여 React Native 프로젝트에 전화번호 인증 기능을 추가해보자.">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-04-07T16:57:43.000Z">
<meta property="article:modified_time" content="2023-04-07T16:57:43.000Z">
<meta property="article:author" content="oxcarxierra | 오승석">
<meta property="article:tag" content="오승석">
<meta property="article:tag" content="oxcarxierra">
<meta property="article:tag" content="Seungseok Oh">
<meta property="article:tag" content="서울과학고등학교">
<meta property="article:tag" content="서울대학교">
<meta name="twitter:card" content="summary">
    
    
        
    
    
        <meta property="og:image" content="https://oxcarxierra.github.io/assets/images/profile.jpg">
    
    
        <meta property="og:image" content="https://i.imgur.com/8tlrvDv.png">
        <meta class="swiftype" name="image" data-type="enum" content="https://i.imgur.com/8tlrvDv.png">
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/all.css">

    
<link rel="stylesheet" href="/assets/css/jquery.fancybox.css">

    
<link rel="stylesheet" href="/assets/css/thumbs.css">

    
<link rel="stylesheet" href="/assets/css/tranquilpeak.css">

    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-19V9VE6BEX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-19V9VE6BEX');
    </script>


    

    
        
    
    <link rel="canonical" href="https://oxcarxierra.github.io/development/rn-firebase-phone-auth/">
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


<header id="header" data-behavior="2">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/" aria-label>
            Blog of oxcarxierra
        </a>
    </div>
    
        
            <a class="header-right-icon " href="/" aria-label="Open the link: /">
        
        
            <i class="fa fa-home fa-lg"></i>
        
        </a>
    
</header>

            <!-- Define author's picture -->






        
    

<nav id="sidebar" data-behavior="2">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
              <img class="sidebar-profile-picture" src="/assets/images/profile.jpg" alt="Author&#39;s picture">
                <a aria-label="Read more about the author" href="/#about">
                </a>
                <h4 class="sidebar-profile-name">oxcarxierra | 오승석</h4>
                
                    <h5 class="sidebar-profile-bio"></h5>
                
            </div>
        
        <div class="sidebar-counts">
          <div class="sidebar-count-button">
            <a class="sidebar-count-link" href="/posts">
              <div class="sidebar-count-title">POSTS</div>
              <div class="sidebar-count-number">51</div>
            </a>
          </div>
          <div class="sidebar-count-button">
            <a class="sidebar-count-link" href="/all-categories">
              <div class="sidebar-count-title">CATEGORIES</div>
              <div class="sidebar-count-number">5</div>
            </a>
          </div>
          <!-- <div class="sidebar-count-button">
            <a class="sidebar-count-link" href="/all-tags">
              <div class="sidebar-count-title">TAGS</div>
              <div class="sidebar-count-number">22</div>
            </a>
          </div> -->
        </div>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/" rel="noopener" title="Home">
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/about" rel="noopener" title="About Me">
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About Me</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/categories/Review" rel="noopener" title="Monthly Reviews">
                        <i class="sidebar-button-icon fa fa-calendar" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Monthly Reviews</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/posts" rel="noopener" title="Posts">
                        <i class="sidebar-button-icon fa fa-pen" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Posts</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-archives" rel="noopener" title="Archives">
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://github.com/OXcarXierra" target="_blank" rel="external nofollow noopener noreferrer" title="GitHub">
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://www.linkedin.com/in/oh-seungseok-370746242/" target="_blank" rel="external nofollow noopener noreferrer" title="LinkedIn">
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://www.instagram.com/_oscarsierra_/" target="_blank" rel="external nofollow noopener noreferrer" title="Instagram">
                        <i class="sidebar-button-icon fab fa-instagram" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Instagram</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="2" class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            [React Native] Firebase 전화번호 인증 기능 추가하기 (Feat. 안드로이드 자동 인증)
        </h1>
    
    
        <div class="post-meta">
  <time datetime="2023-04-08T01:57:43+09:00">
     Apr 08, 2023 
  </time>
  
  <span>in </span>
  
    <a class="category-link" href="/categories/Development/">Development</a>

 
  <span class="post-readingtime">
     - 12 min read
  </span>
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <!-- excerpt -->
<h1 id="table-of-contents"> </h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Google-Firebase-%EC%97%B0%EB%8F%99%ED%95%98%EA%B8%B0"><span class="toc-text">Google Firebase 연동하기</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%EC%9D%B8%EC%A6%9D%EB%B2%88%ED%98%B8-%EC%A0%84%EC%86%A1-%EB%B0%8F-%EB%8C%80%EC%A1%B0-%EA%B2%80%EC%A6%9D-%EC%BD%94%EB%93%9C"><span class="toc-text">인증번호 전송 및 대조 검증 코드</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Troubleshooting"><span class="toc-text">Troubleshooting</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%9A%A0%EF%B8%8F-Google-Playstore-%EB%93%B1%EB%A1%9D-%EC%9D%B4%ED%9B%84-%EC%8B%A4%EA%B8%B0%EA%B8%B0%EC%97%90%EC%84%9C-%EC%9D%B8%EC%A6%9D%EB%B2%88%ED%98%B8-%EB%B0%9C%EC%86%A1-%EC%8B%A4%ED%8C%A8-%EC%9D%B4%EC%8A%88"><span class="toc-text">⚠️ Google Playstore 등록 이후 실기기에서 인증번호 발송 실패 이슈</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%9A%A0%EF%B8%8F-Android-%EA%B8%B0%EA%B8%B0%EC%97%90%EC%84%9C-%EC%9D%B8%EC%A6%9D%EB%B2%88%ED%98%B8-%EC%9E%90%EB%8F%99-%EC%9D%B8%EC%A6%9D%EC%9C%BC%EB%A1%9C-%EC%9D%B8%ED%95%9C-%EC%9D%B8%EC%A6%9D%EB%B2%88%ED%98%B8-%EB%A7%8C%EB%A3%8C-%EC%9D%B4%EC%8A%88"><span class="toc-text">⚠️ Android 기기에서 인증번호 자동 인증으로 인한 인증번호 만료 이슈</span></a></li></ol></li></ol>

<p>HYPE 앱은 전화번호 기반으로 유저 로그인, 회원가입이 이루어지기 때문에 전화번호 인증이 필수적이었다. 그래서 Google Firebase에서 제공하는 문자메세지 인증 서비스를 처음으로 사용해보게 되었다.</p>
<h1 id="Google-Firebase-연동하기"><a href="#Google-Firebase-연동하기" class="headerlink" title="Google Firebase 연동하기"></a>Google Firebase 연동하기</h1><p>먼저 개발하려는 앱과 프로젝트를 연동해주어야 한다. <code>React Native</code> 프로젝트에 쉽게 프로젝트를 연동할 수 있는 <code>react-native-firebase</code> 라이브러리를 사용하면 편하다.<br>연동하는 일련의 방법은 공식문서 및 블로그를 참고했다. Firebase 공식문서는 Swift와 Kotlin 기반으로 설명이 되어있어서, <a target="_blank" rel="external nofollow noopener noreferrer" href="https://velog.io/@ddowoo/react-native-firebase-%EC%97%B0%EB%8F%99">타 블로그</a>가 도움이 많이 되었다.</p>
<p>Firebase에서는 여러 가지 방법의 Authentication(인증)수단을 제공하는데, 그 중 전화(phone)을 이용하면 유저가 입력한 번호로 인증번호를 전송할 수 있다. 그리고 유저가 입력한 인증번호와 대조하면 핸드폰 번호 인증이 가능해진다.</p>
<h1 id="인증번호-전송-및-대조-검증-코드"><a href="#인증번호-전송-및-대조-검증-코드" class="headerlink" title="인증번호 전송 및 대조 검증 코드"></a>인증번호 전송 및 대조 검증 코드</h1><p>대부분의 로직은 <code>React Native Firebase</code>에서 제공하는 <code>Phone Authentication</code> 공식문서를 참고하면 된다.<br>전화번호 인증의 전체적인 로직은 이렇다.</p>
<ol>
<li>전화번호를 매개변수로 <code>signInWithPhoneNumber()</code>함수를 호출하고, 반환된 값을 state로 저장한다.</li>
<li>그러면 firebase에서 해당 전화번호로 OTP(One Time Passcode)가 전송된다.</li>
<li>유저에게서 OTP를 입력받고, 이를 state에 저장된 변수 내 <code>confirm()</code>함수의 매개변수로 넣는다.</li>
<li>인증번호가 맞다면 문제가 없지만, 인증번호가 틀리거나 만료된다면 <code>Error</code>가 반환한다.</li>
</ol>
<p>전체 코드는 아래와 같다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">SignInComponent</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> [phone, setPhone] = useState&lt;string&gt;(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> [verificationCode, setVerificationCode] = useState&lt;string&gt;(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> [confirm, setConfirm] =</span><br><span class="line">    useState&lt;<span class="title class_">FirebaseAuthTypes</span>.<span class="property">ConfirmationResult</span> | <span class="literal">null</span>&gt;(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">const</span> [authenticated, setAuthenticated] = useState&lt;boolean&gt;(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">requestSignInWithPhoneNumber</span> = <span class="keyword">async</span> (<span class="params">phone: string</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 입력받은 전화번호에 국가코드 추가</span></span><br><span class="line">      <span class="keyword">const</span> confirmation = <span class="keyword">await</span> <span class="title function_">auth</span>().<span class="title function_">signInWithPhoneNumber</span>(<span class="string">`+82 <span class="subst">$&#123;phone&#125;</span>`</span>);</span><br><span class="line">      <span class="title function_">setConfirm</span>(confirmation);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="title class_">Alert</span>.<span class="title function_">alert</span>(</span><br><span class="line">        <span class="string">&quot;인증번호를 정상적으로 전송하지 못했어요. 다시 시도해주세요.&quot;</span></span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 인증번호 전송 버튼 클릭시 실행 호출</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">onPressSendCode</span> = <span class="keyword">async</span> (<span class="params">phone: string</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 번호가 11자리가 아니거나, 이미 존재하는 번호이면 여기서 예외처리</span></span><br><span class="line">    <span class="keyword">const</span> onSuccessSignInPhoneNumber = <span class="keyword">await</span> <span class="title function_">requestSignInWithPhoneNumber</span>(</span><br><span class="line">      phone</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (onSuccessSignInPhoneNumber) &#123;</span><br><span class="line">      <span class="comment">// 인증번호가 정상적으로 발송되었을 때 처리</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">requestConfirmVerificationCode</span> = <span class="keyword">async</span> (<span class="params">code: string</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> confirm!!.<span class="title function_">confirm</span>(code);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="title class_">Alert</span>.<span class="title function_">alert</span>(<span class="string">&quot;인증번호가 일치하지 않아요. 다시 시도해주세요.&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">confirmCode</span> = <span class="keyword">async</span> (<span class="params">code: string</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">requestConfirmVerificationCode</span>(code);</span><br><span class="line">    <span class="keyword">if</span> (res) &#123;</span><br><span class="line">      <span class="title function_">setAuthenticated</span>(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 폰인증 백그라운드 자동 인증 리스너 추가 for 안드로이드</span></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> subscriber = <span class="title function_">auth</span>().<span class="title function_">onAuthStateChanged</span>(<span class="function">(<span class="params">user</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (user) &#123;</span><br><span class="line">        <span class="title function_">setAuthenticated</span>(<span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> subscriber; <span class="comment">// 성공시 listener 제거</span></span><br><span class="line">  &#125;, []);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="comment">// 렌더링될 부분</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<h1 id="Troubleshooting"><a href="#Troubleshooting" class="headerlink" title="Troubleshooting"></a>Troubleshooting</h1><h2 id="⚠️-Google-Playstore-등록-이후-실기기에서-인증번호-발송-실패-이슈"><a href="#⚠️-Google-Playstore-등록-이후-실기기에서-인증번호-발송-실패-이슈" class="headerlink" title="⚠️ Google Playstore 등록 이후 실기기에서 인증번호 발송 실패 이슈"></a>⚠️ Google Playstore 등록 이후 실기기에서 인증번호 발송 실패 이슈</h2><p>안드로이드 시뮬레이터에서는 정상적으로 동작하던 인증이 Playstore을 통해서 배포된 앱에서는 <code>Error: [auth/invalid-app-credential] Invalid token</code>에러가 발생한다면, Playstore 앱 서명 <code>SHA-1</code>과 <code>SHA-256</code> 키를 Firebase에 등록했는지 다시 확인해보는 것이 좋다.</p>
<p>앱을 Firebase에 처음으로 연동할 때, <code>SHA-1</code> 키를 입력하고 google-service.json을 다운로드하는 과정을 거친다. 이때 들어가는 <code>SHA-1</code> 키는 디버그용 키이기 때문에, 릴리즈용 키와 Playstore 앱 서명 키까지 추가로 다시 등록해주어야 한다.</p>
<p>릴리즈용 <code>SHA-1</code>, <code>SHA-256</code> Key는 터미널에서 아래 커맨드를 입력하여 얻을 수 있다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -list -v -keystore &quot;C:\work\prj1\prj1.jks&quot;</span><br></pre></td></tr></table></figure>

<p>Playstore 앱 서명 키는 <code>Play Console - 설정(좌측 메뉴) - 앱 무결성 - 앱 서명</code> 에서 확인할 수 있다. 업로드 키가 아닌 <strong>앱 서명 키</strong>를 이용해야 한다!</p>
<p>이후 <code>Firebase Console - 앱 설정 - Android 앱 - SHA 인증서 지문</code> 에서 <strong>디지털 지문 추가</strong>를 클릭해 위에서 얻은 키를 입력해주고, 다시 google-service.json을 앱 폴더 내에 위치시키면 끝!</p>
<h2 id="⚠️-Android-기기에서-인증번호-자동-인증으로-인한-인증번호-만료-이슈"><a href="#⚠️-Android-기기에서-인증번호-자동-인증으로-인한-인증번호-만료-이슈" class="headerlink" title="⚠️ Android 기기에서 인증번호 자동 인증으로 인한 인증번호 만료 이슈"></a>⚠️ Android 기기에서 인증번호 자동 인증으로 인한 인증번호 만료 이슈</h2><p>모든 설정을 마쳤는데도, Android 실기기에서만 인증번호를 확인하는 <code>confirm</code>함수에서 계속 오류를 반환했다. 오류를 재현하는 것 부터 까다로웠는데,</p>
<ul>
<li>iOS 기기는 전혀 문제가 없음</li>
<li>Android Simulator에서 테스트 전화번호로 하면 문제가 없음.</li>
<li>Android Simulator에서 실기기 전화번호로 인증번호를 받으면 문제가 없음.</li>
<li>Android 실기기에서 테스트 전화번호로 하면 문제가 없음.</li>
<li><strong>Android 실기기에서 실기기 전화번호로 인증번호를 받아 입력하면 오류가 발생</strong></li>
</ul>
<p>이유는 <strong>안드로이드 일부 기기에서 문자로 보내진 인증번호를 이용해 자동으로 인증을 진행하기 때문</strong>이었다. 그래서 <code>confirm</code>함수는 이미 실행되고 인증까지 된 상태에서 유저가 똑같은 OTP를 이용해 수동으로 한 번 더 인증을 하니 <code>auth/session-expired</code> 오류가 떴던 것이다.</p>
<p>공식문서의 설명은 아래와 같다.</p>
<blockquote>
<p>Some Android devices can automatically process the verification code (OTP) message, and the user would NOT need to enter the code.<br>Actually, if he&#x2F;she tries to enter it, he&#x2F;she will get an error message because the code was already used in the background.<br>In this function, make sure you hide the component(s) for entering the code and&#x2F;or navigate away from this screen.<br>It is also recommended to display a message to the user informing him&#x2F;her that he&#x2F;she has successfully logged in.</p>
</blockquote>
<p>그래서 인증화면에서는 아래처럼 <code>onAuthStateChanged</code> 리스너를 둬서 로그인(또는 회원가입)이 되어 user객체가 생긴 걸 감지하도록 해야한다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> subscriber = <span class="title function_">auth</span>().<span class="title function_">onAuthStateChanged</span>(<span class="function">(<span class="params">user</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (user) &#123;</span><br><span class="line">      <span class="title function_">setAuthenticated</span>(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> subscriber; <span class="comment">// 성공시 listener 제거</span></span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure>

<p>이 오류를 발견하고 고치는데에 일주일정도 삽질을 했던 것 같다… 이렇게 오랜 시간이 소요됐던 건 네 가지 병크가 겹쳤기 때문이라고 본다.</p>
<ol>
<li>일단 공식문서의 초록 주석을 제대로 안읽었음. 몇몇 기기에서는 자동인증이 진행될 수 있다는 내용을 몰랐음.</li>
<li>실기기에서는 console창에 에러메세지가 뜨지 않아서 OTP expire 오류인지 알아내는데 며칠이 걸렸음.</li>
<li>안드로이드 실기기가 없어서 애초에 디버깅을 지인 핸드폰으로 했기에 시간제한이 있었음.</li>
<li>디버깅하려면 <strong>수정 -&gt; 새로 빌드(및 버전 업) -&gt; 실기기에서 앱 업데이트 -&gt; 확인</strong>의 과정을 매번 거쳐야 해서 속도가 느렸음.</li>
</ol>
<p>안드로이드 자동인증 만든넘… 밤길 조심하세요 진짜</p>
            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a class="post-action-btn btn btn--default tooltip--top" href="/Development/hype-development-review/" data-tooltip="[HYPE 앱 개발기] 희망찼던 시작과 아쉬운 지금, 그리고 배운 것들 " aria-label="PREVIOUS: [HYPE 앱 개발기] 희망찼던 시작과 아쉬운 지금, 그리고 배운 것들 ">
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a class="post-action-btn btn btn--default tooltip--top" href="/Development/hype-troubleshooting-ios-permission-request/" data-tooltip="[React Native] 앱 추적 권한 요청하기 + App Store Connect 추적 권한 제거 버그" aria-label="NEXT: [React Native] 앱 추적 권한 요청하기 + App Store Connect 추적 권한 제거 버그">
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        <!-- 
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://oxcarxierra.github.io/Development/rn-firebase-phone-auth/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://oxcarxierra.github.io/Development/rn-firebase-phone-auth/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://oxcarxierra.github.io/Development/rn-firebase-phone-auth/"
                    title="Share on Google+"
                    aria-label="Share on Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
         -->
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#table-of-contents" aria-label=" ">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    Copyrights &copy; 2023 oxcarxierra | 오승석.
  </span>
  <br>
  <span class="copyrights"> All Rights Reserved. </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="2">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a class="post-action-btn btn btn--default tooltip--top" href="/Development/hype-development-review/" data-tooltip="[HYPE 앱 개발기] 희망찼던 시작과 아쉬운 지금, 그리고 배운 것들 " aria-label="PREVIOUS: [HYPE 앱 개발기] 희망찼던 시작과 아쉬운 지금, 그리고 배운 것들 ">
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a class="post-action-btn btn btn--default tooltip--top" href="/Development/hype-troubleshooting-ios-permission-request/" data-tooltip="[React Native] 앱 추적 권한 요청하기 + App Store Connect 추적 권한 제거 버그" aria-label="NEXT: [React Native] 앱 추적 권한 요청하기 + App Store Connect 추적 권한 제거 버그">
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        <!-- 
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://oxcarxierra.github.io/Development/rn-firebase-phone-auth/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://oxcarxierra.github.io/Development/rn-firebase-phone-auth/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://oxcarxierra.github.io/Development/rn-firebase-phone-auth/"
                    title="Share on Google+"
                    aria-label="Share on Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
         -->
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#table-of-contents" aria-label=" ">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="2">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a class="share-option-btn" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://oxcarxierra.github.io/Development/rn-firebase-phone-auth/" aria-label="Share on Facebook" rel="external nofollow noopener noreferrer">
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Share on Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a class="share-option-btn" target="_blank" href="https://twitter.com/intent/tweet?text=https://oxcarxierra.github.io/Development/rn-firebase-phone-auth/" aria-label="Share on Twitter" rel="external nofollow noopener noreferrer">
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a class="share-option-btn" target="_blank" href="https://plus.google.com/share?url=https://oxcarxierra.github.io/Development/rn-firebase-phone-auth/" aria-label="Share on Google+" rel="external nofollow noopener noreferrer">
                        <i class="fab fa-google-plus" aria-hidden="true"></i><span>Share on Google+</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
              
<div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
    <img id="about-card-picture" src="/assets/images/profile.jpg" alt="Author&#39;s picture">
    
    <h4 id="about-card-name">oxcarxierra | 오승석</h4>
    
    <div id="about-card-bio"></div>
     
    <div id="about-card-job">
      <i class="fa fa-briefcase"></i>
      <br>
      <p>author.job</p>

    </div>
     
  </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/1d1d1d.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/jquery.js"></script>


<script src="/assets/js/jquery.fancybox.js"></script>


<script src="/assets/js/thumbs.js"></script>


<script src="/assets/js/tranquilpeak.js"></script>

<!--SCRIPTS END-->


    




    </body>
</html>
